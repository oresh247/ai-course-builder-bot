# ⚠️ Известные ограничения проекта

## 1. Генерация детального контента модулей через OpenAI

### Проблема

OpenAI API (модели GPT-4, GPT-4-turbo, GPT-4o) **упорно игнорирует** инструкции в промптах и возвращает неправильную структуру JSON при генерации детального контента модулей (лекции со слайдами).

**Ожидаемая структура:**
```json
{
  "module_number": 1,
  "module_title": "...",
  "lectures": [
    {
      "lecture_title": "...",
      "slides": [...]
    }
  ]
}
```

**Фактически возвращается:**
```json
{
  "lesson_title": "...",
  "lesson_goal": "...",
  "content_outline": [...]
}
```

### Попытки решения (НЕ сработали)

❌ **Улучшение промптов** - добавление явных инструкций, примеров, отрицательных примеров
❌ **Prefix prompting** - подсказка начала JSON в assistant-сообщении
❌ **JSON Schema** - использование `response_format` с детальной схемой (модель недоступна или не работает через прокси)
❌ **JSON mode** - `response_format: {"type": "json_object"}` всё равно возвращает неправильную структуру
❌ **Изменение температуры** - от 0.3 до 0.7, без эффекта
❌ **Разные модели** - gpt-4, gpt-4-turbo-preview, gpt-4o-2024-08-06

### Текущее решение

**Используется качественный тестовый контент** для демонстрации функционала.

Функция `generate_module_content()` в `content_generator.py` возвращает заранее подготовленный контент с:
- 3 лекциями
- 8 слайдами на лекцию
- Разными типами слайдов (title, content, code, diagram, quiz, summary)
- Полными полями (learning_objectives, key_takeaways, notes)

### Возможные причины проблемы

1. **Контекст из lessons** - модель видит структуру уроков в промпте и копирует её
2. **Тренировочные данные** - GPT-4 чаще видел структуру "урока" в обучающих данных
3. **Недостаточная строгость** - без Structured Outputs модель интерпретирует свободно
4. **Язык** - русский язык может вносить путаницу ("лекция" vs "урок")
5. **Прокси** - корпоративный прокси может влиять на работу новых фич API

### Альтернативные подходы для будущей реализации

1. **Генерация лекций по одной**
   - Делать N отдельных запросов вместо одного большого
   - Каждый запрос генерирует одну лекцию
   - Более надежно, но медленнее и дороже

2. **Постобработка ответа**
   - Парсить ответ OpenAI и трансформировать структуру
   - Конвертировать lesson → lecture программно
   - Требует сложной логики

3. **Английский язык**
   - Переписать промпты на английском
   - Возможно, модель лучше понимает английские инструкции

4. **Функциональные вызовы (Function Calling)**
   - Использовать Function Calling вместо прямого JSON
   - Определить функцию с параметрами
   - Более надежно, но требует доступа к новым API

5. **Другая модель**
   - Claude 3 Opus
   - Llama 3
   - Mistral
   - Могут лучше следовать инструкциям

## 2. Перегенерация контента через OpenAI

### Статус

**Работает частично** - перегенерация уроков (Lesson) работает, так как возвращает простую структуру.

**Не работает** - перегенерация лекций и слайдов упирается в ту же проблему с неправильной структурой JSON.

### Решение

Перегенерация лекций и слайдов временно **использует тестовый контент** или **возвращает ту же лекцию без изменений**.

## 3. Генерация структуры курса

### Статус

✅ **Работает корректно!**

OpenAI успешно генерирует структуру курса с модулями и уроками. Проблема возникает только на уровне детального контента (лекции со слайдами).

## 4. Прокси и SSL

### Статус

✅ **Решено!**

Реализован обход SSL-сертификатов для работы в корпоративных сетях:
- Патч `httpx.AsyncClient` для Telegram Bot API
- Отключение SSL для OpenAI API через `httpx.Client(verify=False)`
- Настройка прокси через переменные окружения

## Что работает отлично

✅ Создание структуры курса (`/create`)
✅ Просмотр курса (`/view`)
✅ Редактирование модулей (`/edit`)
✅ Экспорт в JSON/HTML/Markdown/TXT (`/export`)
✅ Генерация описания модуля через AI (`/edit` → "AI-генерация цели")
✅ Перегенерация уроков (`/regenerate_lesson`)
✅ SSL fix для корпоративных сетей
✅ Работа через прокси

## Что использует тестовый контент

⚠️ Генерация детального контента модуля (`/generate`)
⚠️ Перегенерация лекций (`/regenerate`)
⚠️ Перегенерация слайдов

---

**Примечание:** Тестовый контент - это не баг, а **осознанное решение** для обеспечения стабильной работы бота. Он содержит качественные примеры лекций и слайдов, которые можно использовать как шаблон.

**Для разработчиков:** Если вы найдете способ заставить OpenAI вернуть правильную структуру - раскомментируйте код в `content_generator.py` и замените `return self._get_test_module_content(module)` на вызов API.

---

**Дата:** 19 октября 2025




